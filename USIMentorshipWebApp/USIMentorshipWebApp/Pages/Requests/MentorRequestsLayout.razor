@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject UserService userService
@inject SessionService sessionService
@using USIMentorshipWebApp.Data;
@using USIMentorshipWebApp.Models
@using System.Linq;
@using USIMentorshipWebApp.Shared.FullProfileInfo;
@using USIMentorshipWebApp.Shared.RequestMentorship;

@*************Pending Requests For Mentors*********@
<body>
    <h3 style="color:dodgerblue"><b>Pending Requests</b></h3>
    @if (pendingList != null)
    {
        @foreach (int user in pendingList)
        {
            <CascadingValue Value
            ="@user">
                <RequestsResultCard1></RequestsResultCard1>
            </CascadingValue>
        }

    }
</body>

@**@

@*************Approved Requests For Mentors*********@
<body>
    <h3 style="color:forestgreen"><b>Approved Requests</b></h3>
    @if (requestsList != null)
    {
        @foreach (int user in requestsList)
        {
            <CascadingValue Value
            ="@user">
                <RequestsResultCard2></RequestsResultCard2>
            </CascadingValue>
        }

    }
</body>

@*************Denied Requests For Mentors*********@
<body>
    <h3 style="color:grey"><b>Declined Requests</b></h3>
    @if (declinedList != null)
    {
        @foreach (int user in declinedList)
        {
            <CascadingValue Value="@user">
                <RequestsResultCard2></RequestsResultCard2>
            </CascadingValue>
        }

    }
</body>

@code {
    List<Role> userRoles;
    User loggedInUser;
    private UsiMentorshipApplicationContext _context = new UsiMentorshipApplicationContext();
    List<int> pendingList = new List<int>(); // Initialize pendingList
    List<int> declinedList = new List<int>(); // Initialize declinedList
    List<int> requestsList = new List<int>(); // Initialize requestsLis    //need to figure out why it keeps throwing a null exception!
    List<User> userList = new List<User>();
    public int? matchId;

    protected override async void OnInitialized()
    {
        userList = await userService.GetUsers();  //returning null exception now...

        loggedInUser = sessionService.SessionUser;
        userRoles = sessionService.Roles;

        matchId = _context.UserMatches
                  .Where(ur => ur.UserId == loggedInUser.UserId)
                      .Select(ur => ur.MatchId)
                      .FirstOrDefault();
        foreach (User user in userList) 
        {
            int? matchedId = _context.UserMatches
                  .Where(ur => ur.UserId == user.UserId)
                      .Select(ur => ur.MatchId)
                      .FirstOrDefault();
            string? status = _context.Matches
                  .Where(ur => ur.MatchId == matchedId)
                      .Select(ur => ur.Status)
                      .FirstOrDefault();
            if (user.UserId != loggedInUser.UserId && matchedId == matchId)
            {
                if (status == "Pending")
                {
                    pendingList?.Add(user.UserId);
                }
                else if (status == "Declined")
                {
                    declinedList?.Add(user.UserId);
                }
                else if (status == "Approved")
                {
                    requestsList?.Add(user.UserId);
                }
            }
        }
    }
}
